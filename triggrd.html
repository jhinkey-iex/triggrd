<html>
    <head>
        <title>Triggrd</title>
<script>
const token='pk_ee6a174ecb4e4aaf99ea0da688a9b367';
const log = console;
let party;

const triggerInfo = {
    ballot: {
        /* url can be function or string */
        url() {
            return 'https://cloud.iexapis.com/v1/query/DEV/' +
                   'GENERIC_BALLOT_AVERAGES/2022/' + party + '?last=1';
        },
        period: 10 * 1000,
        /* The state is kept along with the trigger definitions for convenience. */
        state: {
        },
        handleUpdate(ti, data) {
            if (data.length && ti.state.el) {
                const el = data[0];
                const oldDiff = ti.state.el.hi - ti.state.el.lo;
                const newDiff = el.hi - el.lo;
                log.debug('oldDiff: %d, newDiff: %d', oldDiff, newDiff);
                if (newDiff < oldDiff)
                    log.info("kitten me");
                else
                    log.info("don't kitten me");
            }
            if (data.length) {
                log.debug('save data: %s', JSON.stringify(data[0]));
                ti.state.el = data[0];
            }
        }
    },
    recession: {
        url: '', // TODO
        period: 10000,
    },
};

function pollTrigger(ti) {
    log.debug("pollTrigger: %s", ti.url);
    const urlSansToken = 'function' === typeof(ti.url) ? ti.url() : ti.url;
    const sep = urlSansToken.includes('?') ? '&' : '?';
    const url = urlSansToken + sep + 'token=' + token;
    log.debug("URL: %s", url);
    fetch(url)
        .then(response => {
            if (response.status === 200)
                return response.json();
            else
                return Promise.reject(`status of ${url} is ${response.status}`);
        })
        .then(ti.handleUpdate.bind(null, ti))
        .catch(e => log.error("polling %s error: %o", url, e));
}

function nextPage(current, next) {
    document.getElementById(current).style.visibility = 'hidden';
    document.getElementById(next).style.visibility = 'visible';
}

function startPollingTrigger(triggerName) {
    log.debug("start polling trigger %s", triggerName);
    const ti = triggerInfo[triggerName];
    pollTrigger(ti);
    setInterval(pollTrigger, ti.period, ti);
}

function actOnTriggers() {
    party = document.forms[0].party.value;
    const triggers = document.forms[0];
    for (const tr of triggers)
        if (tr.checked)
            startPollingTrigger(tr.value);
    nextPage("second", "third");
}
</script>
<style>
div {
    visibility: hidden;
    position: absolute;
    top: 0px;
    left: 0px;
}
</style>
</head>

<body>

<div id=first style='visibility: visible'>
    <!-- This is the first page users see when they open the app -->
    <h1>Welcome to Triggrd!</h1>

    <p>
        We're here to calm your nerves and make you feel good in the midst of life's storms and hiccups.
    </p>

    <a href='' onClick='nextPage("first", "basic_personal_info"); return false;'>Get Started</a>
</div>

<div id=basic_personal_info>
    <!-- This is the basic_personal_info page -->
    <h1>Tell us about yourself</h1>

    <form> <!-- action="some-path.*"-->
        <label for="fname">First name:</label>
        <input type="text" id="fname" name="fname"><br>

        <label for="political_party">Political party affiliation (if politics gets you fired up):</label><br>
        <input type="radio" id="democrat" name="democrat" value="Democrat">
        <label for="democrat">Democrat</label><br>
        <input type="radio" id="republican" name="republican" value="Republican">
        <label for="republican">Republican</label><br>
        <input type="radio" id="neither_party" name="neither_party" value="Neither party">
        <label for="neither_party">Neither</label><br>

        <a href='' onClick='nextPage("basic_personal_info", "triggers"); return false;'>
            <input type="submit" value="Submit">
        </a>
    </form>
 </div>

 <div id=triggers>
    <h1>Triggers?</h1>

    <p>Which events make you anxious?</p>
    
    <form>
        
        <input type="checkbox" id="recession" name="recession" value="recession">
        <label for="recession">Recession probability increases</label><br>
        
        <input type="checkbox" id="jet-fuel" name="jet-fuel" value="jet-fuel">
        <label for="jet-fuel">Jet fuel price hikes</label><br>
        
        <input type="checkbox" id="crypto" name="crypto" value="crypto">
        <label for="crypto">Crypto crashes</label><br>
        
        <input type="checkbox" id="politics" name="politics" value="politics">
        <label for="politics">Political party affiliation drops</label><br>

        <a href='' onClick='nextPage("triggers", "your_love_lang"); return false;'>
            <input type="submit" value="Submit">
        </a>
    </form>
  </div>

  <div id=your_love_lang>
     <h1>Your love language?</h1>

     <p>
        What fills your "love tank"?
     </p>
 
     <form>
        <input type="radio" id="gifts" name="love_lang" value="Receiving gifts">
         <label for="gifts">Receiving gifts - it's the thoughfulness that counts</label><br>
         <input type="radio" id="acts_of_service" name="love_lang" value="Acts of service">
         <label for="acts_of_service">Acts of Service - ease my burden, please!</label><br>
         <input type="radio" id="physcal_touch" name="love_lang" value="Physical touch">
         <label for="physcal_touch">Physical touch - hugs, anyone??</label><br>
         <input type="radio" id="words_of_affirmation" name="love_lang" value="Words of affirmation">
         <label for="words_of_affirmation">Words of affirmation - I'm all ears.</label><br>
         <input type="radio" id="quality_time" name="love_lang" value="Quality time">
         <label for="quality_time">Quality time - stay with me?</label><br>
 
         <a href='' onClick='nextPage("setup_complete", "your_love_lang"); return false;'>
             <input type="submit" value="Submit">
         </a>
     </form>
   </div>

   <div id=level_of_service>
      <h1>Level of Service</h1>
  
      <p>
        Can you ever really have too much love?? Choose plan that fits you:
      </p>

      <form>
          <input type="radio" id="gifts" name="service_level" value="Gifts">
          <label for="gifts">Receiving gifts - it's the thoughfulness that counts</label><br>
          <input type="radio" id="acts_of_service" name="service_level" value="Acts of service">
          <label for="acts_of_service">Acts of Service - ease my burden, please!</label><br>
  
          <a href='' onClick='nextPage("setup_complete", "your_love_lang"); return false;'>
              <input type="submit" value="Submit">
          </a>
      </form>
    </div>

   <div id=setup_complete>
        <h1>Setup Complete</h1>

        <p>
            Congratulations! We have everything we need to give you the TLC you deserve.
        </p>
        <p>
            Get ready to get Triggrd Happy!!
        </p>

        <a href='' onClick='nextPage("setup_complete", "notification_page"); return false;'>Done</a>
   </div>

   <div id=peace_page>
       <!-- Return to this page between notifications-->
        <p>
            Enjoy the Zen ...
        </p>
   </div>

</body>
</html>
<!-- vim:sts=4:et:sw=4: -->